# 测试设计文档生成器

> **模块信息**
> - 层级：L3_Generation
> - 优先级：必须加载
> - 适用范围：测试设计文档生成
> - 依赖：L1_Framework, L2_Analysis, test_generator

---

## 一、模块概述

测试设计文档生成器负责在生成测试用例的同时，同步生成结构化的测试设计文档，确保测试用例和测试设计文档的一致性和完整性。

---

## 二、生成原则

### 2.1 同步生成原则

- **一一对应**：每个测试用例都有对应的测试设计文档场景
- **内容一致**：设计文档内容必须与测试用例实现保持一致
- **版本同步**：测试用例修改时，设计文档必须同步更新
- **完整覆盖**：设计文档必须涵盖所有测试场景

### 2.2 命名规范

```
格式: {测试文件名}.design.md
示例:
  - TreeSet.test.ets -> TreeSet.test.design.md
  - Component.onClick.test.ets -> Component.onClick.test.design.md
```

---

## 三、生成流程

### 3.1 完整生成流程

```
解析测试用例代码
    ↓
提取测试用例信息
    ├─ 测试用例编号 (@tc.number)
    ├─ 测试用例名称 (@tc.name)
    ├─ 测试类型 (@tc.type)
    ├─ 测试级别 (@tc.level)
    ├─ 测试描述 (@tc.desc)
    └─ 测试代码
    ↓
分析测试用例结构
    ├─ 前置条件提取
    ├─ 测试步骤提取
    ├─ 测试数据提取
    └─ 预期结果提取
    ↓
生成测试场景
    ├─ 场景描述生成
    ├─ 场景编号映射
    └─ 场景分类
    ↓
组装测试设计文档
    ├─ 测试概述
    ├─ 测试场景设计
    ├─ 测试覆盖分析
    ├─ 测试依赖关系
    ├─ 测试环境要求
    ├─ 注意事项
    └─ 变更记录
    ↓
输出测试设计文档
    └─ 保存为 {测试文件名}.design.md
```

### 3.2 信息提取规则

#### 3.2.1 从 @tc 注释提取

```typescript
/**
 * @tc.name testAddStringNormal001
 * @tc.number SUB_UTILS_UTIL_TREESET_ADD_PARAM_001
 * @tc.desc 测试 TreeSet 的 add 方法 - 正常字符串参数场景
 * @tc.type FUNCTION
 * @tc.size MEDIUMTEST
 * @tc.level LEVEL1
 */
```

提取内容：
- 测试用例编号：`SUB_UTILS_UTIL_TREESET_ADD_PARAM_001`
- 测试用例名称：`testAddStringNormal001`
- 测试类型：`FUNCTION`
- 测试级别：`LEVEL1`
- 场景描述：`测试 TreeSet 的 add 方法 - 正常字符串参数场景`

#### 3.2.2 从测试代码提取

```typescript
it('testAddStringNormal001', Level.LEVEL1, () => {
  let treeSet = new TreeSet<string>();
  let result = treeSet.add("hello");
  expect(result).assertTrue();
});
```

提取内容：
- 前置条件：`TreeSet 实例已创建，容器为空`
- 测试步骤：
  ```
  1. 创建 TreeSet<string> 实例
  2. 调用 add() 方法，参数为 "hello"
  3. 验证返回值为 true
  ```
- 测试数据：`参数: "hello"`
- 预期结果：`方法执行成功，返回值为 true，元素成功添加到集合中`

---

## 四、文档结构

### 4.1 标准文档结构

```markdown
# {API名称} 测试设计文档

## 测试概述

### 测试对象
- **API名称**: {完整API路径}
- **API类型**: {类/接口/函数}
- **测试文件**: {测试文件路径}
- **测试设计文档**: {设计文档路径}

### 测试目标
[测试目标和预期成果说明]

## 测试场景设计

### 场景1: {场景名称}

| 项目 | 内容 |
|------|------|
| **场景描述** | {场景详细描述} |
| **测试用例编号** | SUB_{子系统}_{模块}_{API}_{TYPE}_{序号} |
| **测试用例名称** | {testCaseName} |
| **前置条件** | {前置条件说明} |
| **测试步骤** | 1. 步骤1<br>2. 步骤2<br>3. 步骤3 |
| **预期结果** | {预期结果说明} |
| **测试类型** | {FUNCTION/PERFORMANCE/SECURITY/COMPATIBILITY} |
| **测试级别** | {Level0/Level1/Level2/Level3/Level4} |
| **测试数据** | {测试输入数据说明} |

### 场景2: {场景名称}
[重复上述格式]

## 测试覆盖分析

| 测试类型 | 测试用例数 | 覆盖说明 |
|---------|-----------|---------|
| 参数测试 | XX | {说明} |
| 错误码测试 | XX | {说明} |
| 返回值测试 | XX | {说明} |
| 边界值测试 | XX | {说明} |

## 测试依赖关系

### 依赖的测试用例
- [ ] {依赖用例1}
- [ ] {依赖用例2}

### 被依赖的测试用例
- [ ] {被依赖用例1}

## 测试环境要求

- **系统版本**: OpenHarmony API {版本}
- **子系统**: {子系统名称}
- **设备类型**: {设备类型}
- **网络环境**: {网络环境说明}

## 注意事项

[测试执行过程中的注意事项和风险说明]

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| 1.0 | YYYY-MM-DD | 初始版本 | {作者} |
```

---

## 五、场景生成规则

### 5.1 场景描述生成

根据测试用例类型生成场景描述：

| 测试类型 | 场景描述模板 | 示例 |
|---------|------------|------|
| **参数测试** | 测试 {API} 的 {method} 方法在 {参数类型}={参数值} 场景下的行为 | 测试 TreeSet 的 add 方法在参数为正常字符串时的行为 |
| **错误码测试** | 测试 {API} 的 {method} 方法在 {触发条件} 时抛出错误码 {code} | 测试 TreeSet 的 popFirst 方法在容器为空时抛出错误码 401 |
| **返回值测试** | 测试 {API} 的 {method} 方法的返回值类型和值 | 测试 TreeSet 的 getFirst 方法的返回值类型和值 |
| **边界值测试** | 测试 {API} 的 {method} 方法在 {边界值} 边界下的行为 | 测试 TreeSet 的 add 方法在参数为最大长度字符串时的行为 |

### 5.2 测试步骤生成

从测试用例代码中提取测试步骤，遵循以下规则：

1. **步骤编号**：使用数字编号，从 1 开始
2. **步骤描述**：清晰、简洁、可执行
3. **步骤顺序**：按照代码执行顺序排列
4. **步骤数量**：通常 3-5 步

示例：

```typescript
// 测试用例代码
it('testAddStringNormal001', Level.LEVEL1, () => {
  let treeSet = new TreeSet<string>();
  let result = treeSet.add("hello");
  expect(result).assertTrue();
});
```

生成的测试步骤：

```
1. 创建 TreeSet<string> 实例
2. 调用 add() 方法，参数为 "hello"
3. 验证返回值为 true
```

### 5.3 预期结果生成

从测试用例代码的断言中提取预期结果：

| 断言类型 | 预期结果生成规则 | 示例 |
|---------|----------------|------|
| `assertTrue()` | 操作执行成功，返回值为 true | 方法执行成功，返回值为 true |
| `assertFalse()` | 操作执行失败，返回值为 false | 方法执行失败，返回值为 false |
| `assertEqual(value)` | 返回值等于 {value} | 返回值等于 true |
| `assertLarger(0)` | 返回值大于 0 | 返回值大于 0 |
| `assertLess(value)` | 返回值小于 {value} | 返回值小于 {value} |
| `error.code` | 抛出 BusinessError 异常，错误码为 {code} | 抛出 BusinessError 异常，错误码为 401 |

---

## 六、覆盖分析生成

### 6.1 覆盖统计表格

根据生成的测试用例类型生成覆盖分析表格：

```markdown
## 测试覆盖分析

| 测试类型 | 测试用例数 | 覆盖说明 |
|---------|-----------|---------|
| 参数测试 | 5 | 测试了 string 类型的各种场景：正常值、空字符串、null、undefined、超长字符串 |
| 错误码测试 | 2 | 测试了错误码 401（参数错误）和 10200010（容器为空） |
| 返回值测试 | 3 | 测试了返回值的有效值、undefined 和类型验证 |
| 边界值测试 | 1 | 测试了字符串的最大长度边界 |
```

### 6.2 覆盖说明生成规则

- **参数测试**：列出测试的参数类型和具体场景
- **错误码测试**：列出测试的错误码和触发条件
- **返回值测试**：列出测试的返回值类型和场景
- **边界值测试**：列出测试的边界值类型

---

## 七、依赖关系生成

### 7.1 依赖关系识别

从测试用例代码中识别依赖关系：

1. **beforeAll/afterAll**：可能存在依赖关系
2. **共享状态**：多个测试用例共享测试数据
3. **执行顺序**：某些测试用例依赖于前置测试用例的执行

### 7.2 依赖关系记录

```markdown
## 测试依赖关系

### 依赖的测试用例
- [ ] testAddStringNormal001 - 需要先执行添加操作
- [ ] testTreeSetNotEmpty002 - 需要容器非空

### 被依赖的测试用例
- [ ] testPopFirstNormal001 - 被后续删除操作依赖
- [ ] testGetSizeAfterAdd002 - 被后续大小验证依赖
```

---

## 八、环境要求生成

### 8.1 环境信息提取

从测试用例和 API 定义中提取环境信息：

- **系统版本**：从 API 的 `@since` 标签或工程配置中提取
- **子系统**：从子系统中提取
- **设备类型**：根据测试类型判断（如 UI 测试需要设备）
- **网络环境**：根据 API 功能判断（如网络 API 需要网络）

### 8.2 环境要求示例

```markdown
## 测试环境要求

- **系统版本**: OpenHarmony API 10+
- **子系统**: Utils
- **设备类型**: 通用设备（Phone、Tablet）
- **网络环境**: 不需要
```

---

## 九、注意事项生成

### 9.1 注意事项识别

从测试用例代码中识别注意事项：

- **特殊条件**：测试需要特殊条件（如权限、网络）
- **已知问题**：已知的限制或问题
- **执行顺序**：需要按特定顺序执行
- **清理要求**：测试后需要清理资源

### 9.2 注意事项示例

```markdown
## 注意事项

1. **权限要求**：部分测试用例需要系统权限，请确保测试环境已配置正确权限
2. **执行顺序**：测试用例按照场景编号顺序执行，请不要调整执行顺序
3. **资源清理**：每个测试用例执行后自动清理测试数据，但建议在测试前检查容器状态
4. **内存管理**：长时间运行大量测试用例时，请注意内存使用情况
```

---

## 十、变更记录生成

### 10.1 初始版本记录

首次生成测试设计文档时，记录初始版本：

```markdown
## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| 1.0 | 2026-02-10 | 初始版本 | oh-xts-generator-template |
```

### 10.2 更新版本记录

当测试用例修改或新增时，更新变更记录：

```markdown
## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| 1.0 | 2026-02-10 | 初始版本 | oh-xts-generator-template |
| 1.1 | 2026-02-11 | 新增场景5：超长字符串参数测试 | User |
| 1.2 | 2026-02-12 | 修改场景3的预期结果描述 | User |
```

---

## 十一、质量检查

### 11.1 质量检查清单

生成测试设计文档后，必须进行质量检查：

- ✅ **完整性**：所有章节都已生成
- ✅ **一致性**：设计文档与测试用例内容一致
- ✅ **准确性**：测试步骤和预期结果准确无误
- ✅ **规范性**：文档格式符合模板要求
- ✅ **可读性**：文档语言清晰、易懂
- ✅ **可维护性**：变更记录完整，易于更新

### 11.2 质量检查方法

1. **自动检查**：
   - 检查文档结构完整性
   - 检查必填字段是否存在
   - 检查格式规范性

2. **人工检查**：
   - 检查内容一致性
   - 检查语言表达准确性
   - 检查可读性

---

## 十二、更新机制

### 12.1 测试用例修改时的更新

当测试用例修改时，必须同步更新测试设计文档：

1. **识别修改的测试用例**
2. **定位对应的测试场景**
3. **更新场景内容**
4. **更新变更记录**
5. **版本号递增**

### 12.2 新增测试用例时的更新

当新增测试用例时，必须同步更新测试设计文档：

1. **分析新增的测试用例**
2. **生成新的测试场景**
3. **添加到文档中**
4. **更新覆盖分析**
5. **更新变更记录**
6. **版本号递增**

### 12.3 删除测试用例时的更新

当删除测试用例时，必须同步更新测试设计文档：

1. **识别删除的测试用例**
2. **删除对应的测试场景**
3. **更新覆盖分析**
4. **更新变更记录**
5. **版本号递增**

---

## 十三、最佳实践

### 13.1 文档命名

- 使用与测试文件对应的命名
- 保持命名简洁明了
- 使用小写字母和连字符

### 13.2 版本管理

- 每次更新都记录变更内容
- 版本号遵循语义化版本规范
- 变更记录详细、准确

### 13.3 内容维护

- 保持文档与测试用例同步更新
- 定期检查文档的准确性和完整性
- 及时修复文档中的错误和不一致之处

### 13.4 协作规范

- 明确文档的所有者和维护者
- 建立文档更新的评审机制
- 确保团队成员了解文档规范

---

## 十四、示例文档

### 14.1 完整示例

参见 `examples/TreeSet.test.design.md` 查看完整的测试设计文档示例。

### 14.2 场景示例

参见 `examples/scenarios/` 查看各种测试场景的设计文档示例。
