# PR Description Template

Pull Request 描述模板和编写指南。

## PR 描述结构

```markdown
## Summary

<2-3 个要点，简要描述 PR 的主要改动>

## Changes

<按组件或模块分类的详细改动列表>

## Test Plan

<测试计划和验证步骤>

## Related Issue

<关联的 Issue 号>

## Additional Notes

<任何额外说明（可选）>

---
Generated by create-pr skill
```

## 完整模板

```markdown
## Summary

- <主要改动 1>
- <主要改动 2>
- <主要改动 3>

## Changes

### Component Name

**file_path1**:
- Change description
- Another change

**file_path2**:
- New function/class added
- Modified existing logic

### Another Component

**file_path3**:
- Change description

## Breaking Changes (if applicable)

<如果有破坏性更改，在此说明>

<如果有 API 变更，在此说明>

## Test Plan

- [ ] Unit tests: <测试套件名称>
- [ ] Integration tests: <测试内容>
- [ ] Manual testing: <手动测试场景>
- [ ] Performance testing: <性能测试（如适用）>

## Related Issue

Fixes #<issue-number>
Relates to #<issue-number>

## Additional Notes

<任何需要审阅者注意的事项>

## Checklist

- [ ] Code follows project style guidelines
- [ ] Self-review completed
- [ ] Comments added to complex code
- [ ] Documentation updated
- [ ] No new warnings generated
- [ ] Tests added/updated
- [ ] All tests pass
- [ ] Build succeeds

---
Generated by create-pr skill
```

## 实际示例

### 功能添加 PR

```markdown
## Summary

- Add sheet selection support to Grid component with new API methods
- Implement SelectSheet/DeselectSheet/IsSheetSelected in GridPattern
- Add comprehensive unit tests for sheet selection functionality

## Changes

### Grid Component (frameworks/core/components_ng/pattern/grid/)

**grid_pattern.h**:
- Add `SelectSheet(int32_t sheetIndex)` method
- Add `DeselectSheet(int32_t sheetIndex)` method
- Add `IsSheetSelected(int32_t sheetIndex) const` method
- Add `selectedSheets_` member variable (std::set<int32_t>)

**grid_pattern.cpp**:
- Implement sheet selection logic
- Validate sheet index bounds before selection
- Emit selection events on sheet selection change
- Integrate with existing item selection system

**grid_model_ng.cpp**:
- Add sheet selection related properties to GridModel
- Support sheet selection in JSON parser

### Tests (test/unittest/pattern/grid/)

**grid_pattern_sheet_selection_test.cpp** (new file):
- Add `GridPatternSheetSelectionTest` test suite
- Test SelectSheet with valid indices
- Test SelectSheet with invalid indices (out of bounds)
- Test DeselectSheet functionality
- Test IsSheetSelected query operations
- Test edge cases (empty grid, single sheet, duplicate selections)
- Test selection event emission

### API Changes

New public APIs:
```cpp
// Select all items in the specified sheet
void SelectSheet(int32_t sheetIndex);

// Deselect all items in the specified sheet
void DeselectSheet(int32_t sheetIndex);

// Check if a sheet is currently selected
bool IsSheetSelected(int32_t sheetIndex) const;
```

## Test Plan

- [x] Unit tests: GridPatternSheetSelectionTest suite (89 tests, all pass)
- [x] Code review: Logic verified for correctness
- [ ] Manual testing: Test with Grid component in sample app
- [ ] Integration testing: Verify sheet selection works with other Grid features
- [ ] Performance testing: Verify no performance regression with large grids

## Related Issue

Fixes #12345 - Sheet selection support for Grid component

## Additional Notes

This change is backward compatible. Existing item-level selection APIs
continue to work as before. Sheet selection is an additional feature
that can be used alongside item selection.

## Checklist

- [x] Code follows project style guidelines
- [x] Self-review completed
- [x] Comments added to complex code
- [ ] Documentation updated (pending)
- [x] No new warnings generated
- [x] Tests added/updated
- [x] All tests pass
- [x] Build succeeds

---
Generated by create-pr skill
```

### Bug 修复 PR

```markdown
## Summary

- Fix memory leak in MenuPattern::OnDetachFromTree
- Add proper cleanup for submenu references
- Add unit test to verify cleanup

## Changes

### Menu Component (frameworks/core/components_ng/pattern/menu/)

**menu_pattern.cpp**:
- Fix: Reset `submenu_` smart pointer in OnDetachFromTree
- Add null check before accessing submenu in event handlers
- Ensure submenu references are released when menu is destroyed

**menu_pattern.h**:
- Add comment documenting submenu lifecycle management

### Tests (test/unittest/pattern/menu/)

**menu_pattern_cleanup_test.cpp** (new file):
- Add test verifying submenu cleanup on detach
- Test multiple menu creation/destruction cycles
- Verify no memory leaks using memory profiler

## Root Cause

MenuPattern stored submenu_ as a RefPtr but never explicitly
reset it in OnDetachFromTree. This caused circular references
when menus were dynamically created and destroyed, leading to
memory accumulation.

## Fix Details

Before:
```cpp
void MenuPattern::OnDetachFromTree() {
    // submenu_ not reset here
}
```

After:
```cpp
void MenuPattern::OnDetachFromTree() {
    submenu_.Reset();  // Explicitly release submenu reference
}
```

## Verification

Memory profile before fix:
- 100 menu cycles: 45 MB leaked
- Leaked objects: submenu RefPtrs

Memory profile after fix:
- 100 menu cycles: 0 MB leaked
- All submenu references properly released

## Test Plan

- [x] Unit tests: MenuPatternCleanupTest (all pass)
- [x] Memory profiling: Verified no leaks with 1000 menu cycles
- [x] Manual testing: Dynamic menu creation/destruction in sample app
- [ ] Regression testing: Verify existing menu functionality unchanged

## Related Issue

Fixes #67890 - Memory leak in MenuPattern

---
Generated by create-pr skill
```

### 重构 PR

```markdown
## Summary

- Extract common layout logic from Grid and List to base class
- Reduce code duplication by ~150 lines
- Improve maintainability and testability

## Changes

### Layout Algorithm (frameworks/core/components_ng/layout/)

**flex_layout_algorithm.h** (new file):
- Create FlexLayoutAlgorithm base class
- Extract common flex layout calculation methods:
  - `CalculateChildConstraints()`
  - `MeasureChildrenWithFlex()`
  - `DistributeRemainingSpace()`

**flex_layout_algorithm.cpp** (new file):
- Implement extracted layout logic
- Add comprehensive documentation

### Grid Component

**grid_layout_algorithm.h/cpp**:
- Remove duplicated flex layout code
- Inherit from FlexLayoutAlgorithm
- Use base class methods for common operations

### List Component

**list_layout_algorithm.h/cpp**:
- Remove duplicated flex layout code
- Inherit from FlexLayoutAlgorithm
- Use base class methods for common operations

### Tests

Update existing tests to use new base class:
- `grid_layout_algorithm_test.cpp`
- `list_layout_algorithm_test.cpp`

Add new tests:
- `flex_layout_algorithm_test.cpp` (new file)

## Impact

**Code metrics**:
- Lines removed: 320
- Lines added: 210 (net reduction: 110 lines)
- Duplication reduced: ~150 lines
- Test coverage: Increased from 65% to 78%

**No functional changes**:
- All existing tests pass
- Layout behavior verified to be identical
- Performance benchmarks show no regression

## Benefits

1. **Single source of truth**: Flex layout logic in one place
2. **Easier maintenance**: Bug fixes apply to both Grid and List
3. **Better testability**: Base class can be tested independently
4. **Future extensibility**: Other components can use base class

## Test Plan

- [x] Unit tests: All existing tests pass
- [x] New tests: FlexLayoutAlgorithm test suite
- [x] Comparison testing: Layout output identical before/after refactor
- [x] Performance testing: No performance regression
- [ ] Code review: Verify refactoring correctness

## Related Issue

Relates to #54321 - Improve code maintainability

---
Generated by create-pr skill
```

## 编写指南

### Summary 部分

- **简洁明了**：2-3 个要点
- **用户视角**：关注功能而非实现
- **使用祈使句**："Add", "Fix", "Refactor"

**好的示例**：
```
- Add sheet selection support to Grid component
- Fix memory leak in MenuPattern cleanup
- Extract common layout logic to reduce duplication
```

### Changes 部分

- **按组件分类**：每个组件一个子标题
- **列出文件**：标明修改的文件路径
- **描述改动**：简要说明每个文件的主要改动
- **代码片段**：对重要改动添加代码对比

**格式**：
```markdown
### Component Name

**file_path**:
- Change description
- Another change

**another_file_path**:
- New feature description
```

### Breaking Changes 部分

如果 PR 包含破坏性更改，必须明确说明：

```markdown
## Breaking Changes

### API Changes

The following APIs have been changed:

**Before**:
```cpp
void SelectItem(int index);
```

**After**:
```cpp
void SelectItem(const ItemPosition& position);
```

**Migration guide**:
```cpp
// Old code
grid->SelectItem(5);

// New code
grid->SelectItem({.row = 0, .column = 5});
```

### Behavior Changes

- Grid selection now requires explicit model initialization
- Default selection behavior changed from multi to single selection

```

### Test Plan 部分

列出测试类型和状态：

```markdown
## Test Plan

- [x] Unit tests: <测试套件名称>
- [ ] Integration tests: <集成测试>
- [ ] Manual testing: <手动测试场景>
- [ ] Performance testing: <性能测试>
- [ ] Regression testing: <回归测试>
```

### Related Issue 部分

关联相关 Issue：

```
Fixes #12345        # PR 合并后自动关闭 Issue
Relates to #67890   # 仅关联，不关闭
Refs #11111         # 引用参考
```

### Checklist 部分

标准的 PR 检查清单：

```markdown
## Checklist

- [ ] Code follows project style guidelines
- [ ] Self-review completed
- [ ] Comments added to complex code
- [ ] Documentation updated
- [ ] No new warnings generated
- [ ] Tests added/updated
- [ ] All tests pass
- [ ] Build succeeds
```

## 常见错误

### ❌ 太简略

```markdown
## Summary

Fix bug.

## Changes

Changed code.

## Test Plan

Tested.
```

**问题**：没有提供任何有用信息

### ❌ 实现细节过多

```markdown
## Summary

- Add selectedSheets_ member variable of type std::set<int32_t>
- Call SelectSheet in OnModifyDone if selection enabled
- Update GetSelectedSheets to return const reference
```

**问题**：关注实现细节而非功能价值

**改进为**：
```markdown
## Summary

- Add sheet selection support to Grid component
- Enable selecting entire sheets of items at once
- Improve UX for grids with spatial grouping
```

### ❌ 缺少测试计划

```markdown
## Summary

Add new feature.

## Changes

Implementation details...

## Related Issue

Fixes #12345
```

**问题**：没有说明如何验证改动

**改进为**：添加完整的 Test Plan 部分

### ❌ 描述和 commit 重复

PR 描述不应该只是复制 commit messages，而应该提供更高层次的汇总。

**Commit messages**（详细的技术改动）:
```
feat: add sheet selection support to Grid component
fix: resolve edge case in sheet selection
test: add unit tests for sheet selection
```

**PR Description**（汇总和用户价值）:
```markdown
## Summary

- Add sheet selection support to Grid component
- Fix edge cases and add comprehensive tests
```

## 自动生成 PR 描述

使用 create-pr skill 自动生成：

```bash
python scripts/create-pr/full_auto_pr.py --analyze-only
```

脚本将：
1. 分析分支的所有 commit
2. 查看完整的 diff
3. 识别主要改动和影响的组件
4. 生成结构化的 PR 描述
5. 包含适当的测试计划
